<!-- confirm -->
@if (confirmationService.isVisible()) {
<div class="confirmation-overlay">
  <div class="confirmation-modal">
    <div class="confirmation-header">
      <h3>âš ï¸ è«‹ç¢ºèªæ“ä½œ</h3>
    </div>
    <div class="confirmation-body">
      <p>{{ confirmationService.message() }}</p>
    </div>
    <div class="confirmation-actions">
      <button class="btn btn-secondary" (click)="confirmationService.cancel()">å–æ¶ˆ</button>
      <button class="btn btn-primary" (click)="confirmationService.confirm()">ç¢ºå®š</button>
    </div>
  </div>
</div>
}

<!-- é é¢æ¨™é¡Œå’Œæ–°å¢æŒ‰éˆ• -->
<div class="header-section">
  <div class="header-content">
    <h1 class="header-title">å•†å“åº«å­˜ç®¡ç†</h1>
  </div>
  <button class="add-btn" (click)="openModal()">
    æ–°å¢å•†å“
  </button>
</div>

<div class="main-card">
  <!-- å•†å“åˆ—è¡¨ -->
  <div class="items-grid">
    @for (item of items; track $index) {
    <div class="item-card">
      <div class="status-badge" [class.inactive]="!item.active">
        {{ item.active ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶' }}
      </div>
      <div class="item-image">
        <img [src]="getImageUrl(item.imageUrl, item.name)" [alt]="item.name" />
      </div>
      <div class="item-info">
        <div class="item-header">
          <h3 class="item-name">{{ item.name }}</h3>
        </div>
        <p class="item-description">{{ item.description }}</p>
        <div class="price-info">
          <span class="original-price">åŸåƒ¹ NT${{ item.originalPrice }}</span>
          <span class="discount-price">ç‰¹åƒ¹ NT${{ item.discountedPrice }}</span>
          <span class="discount-badge">{{ calculateDiscount(item.originalPrice, item.discountedPrice) }}% OFF</span>
        </div>
        <div class="item-details">
          <div class="detail-row">
            <span class="label">æ•¸é‡ï¼š</span>
            <span class="value">{{ item.quantityAvailable }} ä»½</span>
          </div>
          <div class="detail-row">
            <span class="label">åˆ†é¡ï¼š</span>
            <span class="value category-tag">{{ item.category }}</span>
          </div>
          <div class="detail-row">
            <span class="label">å–è²¨æ™‚é–“ï¼š</span>
            <span class="value">{{ item.pickupStartTime }} - {{ item.pickupEndTime }}</span>
          </div>
        </div>
        <div class="item-actions">
          <div>
            <button class="btn btn-secondary" (click)="openModal(item)">ç·¨è¼¯</button>
            <button class="btn btn-deactivate" (click)="removeItem($index)">ä¸‹æ¶</button>
          </div>
          <button class="btn btn-delete" (click)="deleteFoodItem(item, $index)">åˆªé™¤</button>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- ç©ºç‹€æ…‹ -->
  @if (activeItems.length === 0) {
  <div class="empty-state">
    <p>ç›®å‰æ²’æœ‰ä¸Šæ¶çš„å•†å“</p>
    <button class="btn btn-primary" (click)="openModal()">+ æ–°å¢ç¬¬ä¸€å€‹å•†å“</button>
  </div>
  }

  <!-- æ–°å¢/ç·¨è¼¯è¡¨å–®å½ˆçª— -->
  <div class="modal-overlay" [class.show]="isModalOpen"
    [ngClass]="{ 'dark-theme': isChecked, 'light-theme': !isChecked }" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>@if (editingItem) { ç·¨è¼¯å‰©é£Ÿå•†å“ } @else { æ–°å¢å‰©é£Ÿå•†å“ }</h2>
        <button class="btn-close" (click)="closeModal()">Ã—</button>
      </div>
      <form class="item-form" [formGroup]="itemForm" (ngSubmit)="onSubmit()">

        <div class="form-group">
          <label for="name">å‰©é£Ÿåç¨± <span class="required">*</span></label>
          <input class="placeholder" type="text" id="name" formControlName="name" placeholder="è«‹è¼¸å…¥å‰©é£Ÿåç¨±">
        </div>

        <div class="form-group">
          <label for="description">é£Ÿç‰©å…§å®¹æè¿° <span class="required">*</span></label>
          <textarea class="placeholder" id="description" formControlName="description" rows="3"
            placeholder="è«‹æè¿°é£Ÿç‰©å…§å®¹"></textarea>
        </div>

        <section class="productImg-section">
          <h2 class="section-title">å•†å“åœ–ç‰‡ <span class="required">*</span></h2>

          <div class="productImg-upload-area">
            @if (image) {
            <div class="productImg-content">
              <img [src]="image" alt="å•†å“åœ–ç‰‡" class="uploaded-productImg" />
            </div>
            } @else {
            <div class="productImg-empty">
              <div class="empty-icon">ğŸ“·</div>
              <p class="empty-text">å°šæœªä¸Šå‚³åœ–ç‰‡</p>
            </div>
            }
          </div>

          <button class="upload-btn" type="button" (click)="triggerImageUpload()">
            @if (image) { æ›´æ›åœ–ç‰‡ } @else { ä¸Šå‚³åœ–ç‰‡ }
          </button>

          <input type="file" id="foodImageUpload" (change)="handleImageUpload($event)" accept="image/*" hidden />
        </section>

        <div class="form-row">
          <div class="form-group">
            <label for="quantityAvailable">æ•¸é‡ <span class="required">*</span></label>
            <input type="number" id="quantityAvailable" formControlName="quantityAvailable" min="1">
          </div>
          <div class="form-group">
            <label for="category">åˆ†é¡æ¨™ç±¤ <span class="required">*</span></label>
            <!-- <option value="" disabled selected>è«‹é¸æ“‡ä¸€å€‹é¡åˆ¥</option> -->
            <select id="category" formControlName="category">
              @for (category of categories; track category) {
              <option [value]="category">{{ category }}</option>
              }
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="originalPrice">åŸåƒ¹ <span class="required">*</span></label>
            <input class="placeholder" type="number" id="originalPrice" formControlName="originalPrice" min="0"
              placeholder="è«‹è¼¸å…¥åŸåƒ¹">
          </div>
          <div class="form-group">
            <label for="discountedPrice">æŠ˜æ‰£å¾Œåƒ¹æ ¼ <span class="required">*</span></label>
            <input class="placeholder" type="number" id="discountedPrice" formControlName="discountedPrice" min="0"
              placeholder="è«‹è¼¸å…¥æŠ˜æ‰£åƒ¹">
            @if (itemForm.hasError('discountAboveOriginal') && itemForm.get('discountedPrice')?.touched) {
            <div class="error-message">
              æŠ˜æ‰£å¾Œåƒ¹æ ¼ä¸èƒ½å¤§æ–¼åŸåƒ¹ï¼
            </div>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="pickupStartTime">å–è²¨é–‹å§‹æ™‚é–“ <span class="required">*</span></label>
            <select id="pickupStartTime" formControlName="pickupStartTime">
              @for (time of timeSlots; track time) {
              <option [value]="time">{{ time }}</option>
              }
            </select>
          </div>
        <div class="form-group">
  <label for="pickupEndTime">å–è²¨æˆªæ­¢æ™‚é–“ <span class="required">*</span></label>
  <select id="pickupEndTime" formControlName="pickupEndTime">
    @for (time of timeSlots; track time) {
      <option [value]="time" [disabled]="time < itemForm.value.pickupStartTime">
        {{ time }}
        @if (time < itemForm.value.pickupStartTime) {
          <span>(ä¸å¯é¸)</span>
        }
      </option>
    }
  </select>
</div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">@if (editingItem) { æ›´æ–°å•†å“ } @else { æ–°å¢å•†å“ }</button>
        </div>
      </form>
    </div>
  </div>
</div>
