<div class="main-layout">
  @if (viewMode === 'edit') {
  <div class="edit-container">
    <div class="header-section">
      <div class="header-content">
        <h1 class="header-title">å»ºç«‹å•†å®¶</h1>
      </div>
    </div>

    <div class="main-card">
      <section class="info-section">
        <h2 class="section-title">åŸºæœ¬è³‡è¨Šèˆ‡è¯çµ¡è³‡è¨Š</h2>
        <div class="info-grid">
          <div class="basic-info">
            <div class="form-group">
              <label for="businessName" class="form-label">å•†å®¶åç¨±<span class="required">*</span></label>
              <label class="input input-bordered flex items-center gap-2 validator w-full h-12">
                <input id="businessName" type="text" class="grow" placeholder="è«‹è¼¸å…¥å•†å®¶åç¨±" [(ngModel)]="businessData.name"
                  name="businessName" required #businessName="ngModel"></label>
              @if (businessName.invalid && (businessName.dirty || businessName.touched)) {
              <div class="text-red-500 mt-1 text-sm">
                @if (businessName.errors?.['required']) {
                <div>å•†å®¶åç¨±ç‚ºå¿…å¡«æ¬„ä½</div>
                }
              </div>
              }
            </div>

            <div class="form-group">
              <label for="businessDescription" class="form-label">å•†å®¶ä»‹ç´¹<span class="required">*</span></label>
              <textarea id="businessDescription" class="form-textarea" rows="5" placeholder="è«‹è¼¸å…¥å•†å®¶ä»‹ç´¹"
                [(ngModel)]="businessData.description" name="businessDescription" required minlength="10"
                #businessDescription="ngModel"></textarea>
              @if (businessDescription.invalid && (businessDescription.dirty || businessDescription.touched)) {
              <div class="text-red-500 mt-1 text-sm">
                @if (businessDescription.errors?.['required']) {
                <div>å•†å®¶ä»‹ç´¹ç‚ºå¿…å¡«æ¬„ä½</div>
                }
                @if (businessDescription.errors?.['minlength']) {
                <div>å•†å®¶ä»‹ç´¹è‡³å°‘éœ€è¦10å€‹å­—</div>
                }
              </div>
              }
            </div>

          </div>
          <div class="contact-info">

            <div class="form-group">
              <label for="businessAddress" class="form-label">åœ°å€<span class="required">*</span></label>
              <label class="input input-bordered flex items-center gap-2 validator w-full h-12">
                <input id="businessAddress" type="text" class="grow" placeholder="è«‹è¼¸å…¥å•†å®¶åœ°å€"
                  [(ngModel)]="businessData.address" name="businessAddress" required #businessAddress="ngModel"></label>
              @if (businessAddress.invalid && (businessAddress.dirty || businessAddress.touched)) {
              <div class="text-red-500 mt-1 text-sm">
                @if (businessAddress.errors?.['required']) {
                <div>åœ°å€ç‚ºå¿…å¡«æ¬„ä½</div>
                }
              </div>
              }
            </div>

            <div class="form-group">
              <label for="businessGoogleMapUrl" class="form-label">Google Map ç¶²å€ (éå¿…å¡«)</label>
              <input id="businessGoogleMapUrl" type="text" class="form-input" placeholder="è«‹è¼¸å…¥å•†å®¶åœ°å€ä¹‹Google Map ç¶²å€"
                [(ngModel)]="businessData.googleMapUrl" name="businessGoogleMapUrl">
            </div>

            <div class="form-group">
              <label class="form-label">é›»è©±<span class="required">*</span></label>
              <div class="phone-type-selector">
                <label>
                  <input type="radio" name="phoneType" value="mobile" [(ngModel)]="phoneType">
                  <span>æ‰‹æ©Ÿ</span>
                </label>
                <label>
                  <input type="radio" name="phoneType" value="landline" [(ngModel)]="phoneType">
                  <span>å¸‚è©±</span>
                </label>
              </div>

              @if (phoneType === 'mobile') {
              <div class="phone-input-container mobile-view">
                <label class="input input-bordered flex items-center gap-2 validator w-full h-12">
                  <input type="tel" class="grow" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œä¾‹å¦‚ï¼š0912345678" [(ngModel)]="phone_mobile"
                    name="phone_mobile" required pattern="09\d{8}" maxlength="10" #phoneMobile="ngModel">
                </label>
              </div>
              @if (phoneMobile.invalid && (phoneMobile.dirty || phoneMobile.touched)) {
              <div class="text-red-500 mt-1 text-sm">
                @if (phoneMobile.errors?.['required']) { <div>æ‰‹æ©Ÿè™Ÿç¢¼ç‚ºå¿…å¡«</div> }
                @if (phoneMobile.errors?.['pattern']) { <div>æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢º</div> }
              </div>
              }
              }

              @if (phoneType === 'landline') {
              <div class="phone-input-container landline-view">
                <label class="input input-bordered flex items-center gap-2 validator w-20 h-12">
                  <input type="tel" class="grow area-code ml-2" placeholder="å€ç¢¼" [(ngModel)]="phone_landline_area"
                    name="phone_landline_area" required pattern="0\d{1,2}" #areaCode="ngModel" maxlength="3">
                </label>
                <span class="hyphen">-</span>
                <label class="input input-bordered flex items-center gap-2 validator h-12">
                  <input type="tel" class="grow main-number" placeholder="XXXX" [(ngModel)]="phone_landline_part1"
                    name="phone_landline_part1" required #part1="ngModel" maxlength="4">
                </label>
                <span class="hyphen">-</span>
                <label class="input input-bordered flex items-center gap-2 validator h-12">
                  <input type="tel" class="grow main-number" placeholder="XXXX" [(ngModel)]="phone_landline_part2"
                    name="phone_landline_part2" required #part2="ngModel" maxlength="4">
                </label>
              </div>
              @if ( (areaCode.invalid && (areaCode.dirty || areaCode.touched)) || (part1.invalid && (part1.dirty ||
              part1.touched)) || (part2.invalid && (part2.dirty || part2.touched)) )
              {
              <div class="text-red-500 mt-1 text-sm">
                <div>å€ç¢¼èˆ‡è™Ÿç¢¼çš†ç‚ºå¿…å¡«ï¼Œè«‹ç¢ºèªæ ¼å¼</div>
              </div>
              }
              <div class="form-hint">æç¤ºï¼šè«‹å°‡å¸‚è©±è™Ÿç¢¼åˆ†æ®µè¼¸å…¥ã€‚</div>
              }
            </div>

            <div class="form-group">
              <label class="form-label" for="businessEmail">ä¿¡ç®±<span class="required">*</span></label>
              <label class="input input-bordered flex items-center gap-2 validator w-full h-12">
                <input id="businessEmail" type="email" class="grow" placeholder="è«‹è¼¸å…¥Email"
                  [(ngModel)]="businessData.email" name="businessEmail" required email #businessEmail="ngModel" />
              </label>
              @if (businessEmail.invalid && (businessEmail.dirty || businessEmail.touched)) {
              <div class="text-red-500 mt-1 text-sm">
                @if (businessEmail.errors?.['required']) {
                <div>ä¿¡ç®±ç‚ºå¿…å¡«æ¬„ä½</div>
                }
                @if (businessEmail.errors?.['email']) {
                <div>ä¿¡ç®±æ ¼å¼éŒ¯èª¤!</div>
                }
              </div>
              }
            </div>
          </div>
        </div>
      </section>

      <section class="image-section">
        <h2 class="section-title">åœ–ç‰‡ç®¡ç†</h2>
        <div class="image-grid">
          <div class="image-item">
            <h3 class="subsection-title">å•†å®¶Logo<span class="required">*</span></h3>
            <div class="image-upload-area">
              <div class="image-display">
                @if (images.logo) {
                <img [src]="images.logo" alt="å•†å®¶Logo" class="uploaded-logo">
                } @else {
                <div class="empty-state">
                  <div class="empty-icon">ğŸ“·</div>
                  <p class="empty-text">å°šæœªä¸Šå‚³Logo</p>
                </div>
                }
              </div>
              <div class="image-button-area">
                <button type="button" class="upload-btn" (click)="handleImageUpload('logo')">
                  {{ images.logo ? 'æ›´æ›Logo' : 'ä¸Šå‚³Logo' }}
                </button>
              </div>
            </div>
          </div>
          <div class="image-item">
            <h3 class="subsection-title">å•†å®¶åœ°åœ–<span class="required">*</span></h3>
            <div class="image-upload-area">
              <div class="image-display">
                @if (images.map) {
                <img [src]="images.map" alt="å•†å®¶åœ°åœ–" class="uploaded-map">
                } @else {
                <div class="empty-state">
                  <div class="empty-icon">ğŸ“·</div>
                  <p class="empty-text">å°šæœªä¸Šå‚³åœ°åœ–</p>
                </div>
                }
              </div>
              <div class="image-button-area">
                <button type="button" class="upload-btn" (click)="handleImageUpload('map')">
                  {{ images.map ? 'æ›´æ›åœ°åœ–' : 'ä¸Šå‚³åœ°åœ–' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="banner-section">
        <h2 class="section-title">å•†å®¶æ©«å¹…<span class="required">*</span></h2>
        <div class="banner-upload-area">
          @if (images.banner) {
          <div class="banner-content">
            <img [src]="images.banner" alt="å•†å®¶æ©«å¹…" class="uploaded-banner">
          </div>
          } @else {
          <div class="banner-empty">
            <div class="empty-icon">ğŸ“·</div>
            <p class="empty-text">å°šæœªä¸Šå‚³æ©«å¹…åœ–ç‰‡</p>
          </div>
          }
        </div>
        <button type="button" class="upload-btn" (click)="handleImageUpload('banner')">
          {{ images.banner ? 'æ›´æ›æ©«å¹…åœ–ç‰‡' : 'ä¸Šå‚³æ©«å¹…åœ–ç‰‡' }}
        </button>
      </section>

      <section class="pickup-section">
        <h2 class="section-title">å–é¤è³‡è¨Š</h2>
        <div class="pickup-content">
          <div class="pickup-method">
            <label class="form-label">å–é¤æ–¹å¼ï¼š</label>
            <span class="pickup-badge">{{ businessData.pickupMethod }}</span>
          </div>
          <div class="form-group">
            <label for="pickupInstructions" class="form-label">å–é¤èªªæ˜<span class="required">*</span></label>
            <textarea id="pickupInstructions" class="form-textarea" rows="5" placeholder="è«‹æè¿°é¡§å®¢å¦‚ä½•å–é¤"
              [(ngModel)]="businessData.pickupInstructions" name="pickupInstructions" required
              #pickupInstructions="ngModel"></textarea>
            @if (pickupInstructions.invalid && (pickupInstructions.dirty || pickupInstructions.touched)) {
            <div class="text-red-500 mt-1 text-sm">
              @if (pickupInstructions.errors?.['required']) {
              <div>å–é¤èªªæ˜ç‚ºå¿…å¡«æ¬„ä½</div>
              }
            </div>
            }
          </div>
        </div>
      </section>

      <section class="hours-section">
        <h2 class="section-title">ç‡Ÿæ¥­æ™‚é–“<span class="required">*</span></h2>
        <div class="hours-list">
          @for (dayEntry of dayEntries; track dayEntry[0]) {
          <div class="hours-item">
            <span class="day-name">{{ dayEntry[1] }}</span>
            <div class="hours-controls">
              <div class="rest-toggle">
                <input type="checkbox" class="rest-checkbox" [id]="'rest-' + dayEntry[0]"
                  [checked]="!businessHours[dayEntry[0]].isOpen" (change)="toggleBusinessDay(dayEntry[0])">
                <label [for]="'rest-' + dayEntry[0]" class="rest-label">ä¼‘æ¯</label>
              </div>
              @if (businessHours[dayEntry[0]].isOpen) {
              <div class="time-inputs">
                <select class="time-select" [(ngModel)]="businessHours[dayEntry[0]].openTime"
                  [name]="'openTime-' + dayEntry[0]">
                  <option value="">é–‹å§‹æ™‚é–“</option>
                  @for (time of timeOptions; track time) {
                  <option [value]="time">{{ time }}</option>
                  }
                </select>
                <span class="time-separator">è‡³</span>
                <select class="time-select" [(ngModel)]="businessHours[dayEntry[0]].closeTime"
                  [name]="'closeTime-' + dayEntry[0]">
                  <option value="">çµæŸæ™‚é–“</option>
                  @for (time of timeOptions; track time) {
                  <option [value]="time"
                    [disabled]="isEndTimeOptionDisabled(time, businessHours[dayEntry[0]].openTime)">
                    {{ time }}
                  </option>
                  }
                </select>
              </div>
              } @else {
              <div class="rest-display">
                <span class="rest-badge">ä¼‘æ¯</span>
              </div>
              }
            </div>
          </div>
          }
        </div>

        <button (click)="handleSave()" [disabled]="isSaving" class="save-btn" type="button">
          <span>æ›´æ–°</span>
        </button>
      </section>
    </div>
  </div>
  }

  <!-- é è¦½æ¨¡å¼ -->
  @if (viewMode === 'preview') {
  <div class="preview-container">
    <div class="business-display">
      <div class="display-banner">
        <img class="banner-image" [src]="images.banner">
        <div class="banner-overlay">
          <div class="banner-info">
            <img class="banner-logo" [src]="images.logo">
          </div>
        </div>
      </div>

      <div class="display-content">
        <div class="display-section">
          <h2 class="business-name">{{ businessData.name }}</h2>
          <p class="business-description">{{ businessData.description }}</p>
        </div>

        <hr class="section-divider">

        <div class="display-grid">
          <div class="contact-display">
            <h3 class="display-section-title">è¯çµ¡è³‡è¨Š</h3>
            <div class="contact-list">
              <div class="contact-item">ğŸ“ {{ businessData.address }}</div>
              <div class="contact-item">ğŸ“ {{ businessData.phone }}</div>
              <div class="contact-item">ğŸ“­ {{ businessData.email }}</div>
              <div class="contact-item">ğŸ›ï¸ å–é¤æ–¹å¼ï¼š{{ businessData.pickupMethod }}</div>
            </div>
          </div>

          <div class="hours-display">
            <h3 class="display-section-title">ç‡Ÿæ¥­æ™‚é–“</h3>
            <div class="hours-display-list">
              @for (dayEntry of dayEntries; track dayEntry[0]) {
              <div class="hours-display-item">
                <span>{{ dayEntry[1] }}</span>
                @if (businessHours[dayEntry[0]].isOpen) {
                <span>
                  {{ businessHours[dayEntry[0]].openTime }} - {{ businessHours[dayEntry[0]].closeTime }}
                </span>
                } @else {
                <span>ä¼‘æ¯</span>
                }
              </div>
              }
            </div>
          </div>
        </div>

        <hr class="section-divider">

        @if (businessData.pickupInstructions) {
        <div class="display-section">
          <h3 class="display-section-title">å–é¤èªªæ˜</h3>
          <div class="pickup-instructions">
            <p>{{ businessData.pickupInstructions }}</p>
          </div>
        </div>
        <hr class="section-divider">
        }

        <div class="display-section">
          <h3 class="display-section-title">ä½ç½®åœ°åœ–</h3>
          <a [href]="businessData.googleMapUrl" target="_blank" rel="noopener noreferrer">
            <img class="map-image" [src]="images.map" alt="å•†å®¶åœ°åœ–" />
          </a>
        </div>
      </div>
      <div class="back-button-container">
        <button class="back-btn" (click)="backToEdit()">ç·¨è¼¯</button>
      </div>
    </div>
  </div>
  }
</div>
