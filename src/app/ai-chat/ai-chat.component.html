@if (isLoggedIn$ | async) {
<button (click)="toggleChat()" class="chat-button tooltip tooltip-left" data-tip="AI助理">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon">
    <path fill-rule="evenodd"
      d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v6a.75.75 0 0 0 1.5 0V9Zm-.75-3.75a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-1.5 0V6a.75.75 0 0 1 .75-.75Z"
      clip-rule="evenodd" />
  </svg>
</button>

<div #chatWindow class="chat-window">

  <div class="chat-header" #dragHandle>
    <h2 class="chat-title">AI 助理</h2>
    <div>
      <button (click)="startNewConversation()" class="icon-button" title="開啟新對話">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
          class="icon-sm">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
      </button>
      <button (click)="toggleChat()" class="icon-button close-button" title="關閉視窗">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-sm">
          <path fill-rule="evenodd"
            d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
            clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>

  <div #chatBody class="chat-body">
    @for (message of messages; track $index) {
    <div class="message-container" [class.from-ai]="message.author === 'ai'">
      <div class="message-bubble" [innerHTML]="formatMessage(message.content)"></div>
    </div>
    }

    @if (isLoading) {
    <div class="message-container from-ai">
      <div class="message-bubble">
        <div class="loading-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
    }
  </div>

  <div class="border-t border-gray-200 bg-gray-50">
    <div class="flex items-center gap-3 px-4 py-3">
      <input type="text"
        class="w-full grow border-0 bg-transparent p-0 text-sm placeholder-gray-500 focus:outline-none focus:ring-0 disabled:bg-transparent"
        placeholder="輸入訊息..." [(ngModel)]="userInput" (keyup.enter)="sendMessage()" [disabled]="isLoading" />
      <button (click)="sendMessage()"
        class="grid h-8 w-8 shrink-0 place-items-center rounded-full text-gray-600 transition-colors hover:bg-gray-200 disabled:cursor-not-allowed disabled:text-gray-300"
        [disabled]="isLoading">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
          <path
            d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
        </svg>
      </button>
    </div>
  </div>

</div> }
