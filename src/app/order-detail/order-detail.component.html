@if (isLoading) {
<div class="loading-container">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <p class="loading-text">è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...</p>
  </div>
</div>
}

@if (!isLoading && !orderData) {
<div class="error-container">
  <div class="error-content">
    <div class="error-icon">ğŸ“‹</div>
    <h3 class="error-title">æ‰¾ä¸åˆ°è¨‚å–®</h3>
    <p class="error-description">è«‹æª¢æŸ¥è¨‚å–®ç·¨è™Ÿæ˜¯å¦æ­£ç¢º</p>
    <button class="btn-back" (click)="goBack()">è¿”å›è¨‚å–®åˆ—è¡¨</button>
  </div>
</div>
}

@if (!isLoading && orderData) {
<div class="page-container">

  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <button class="back-button" (click)="goBack()">
          <span class="back-icon">â†</span>
        </button>
        <div class="title-section">
          <h1 class="page-title">è¨‚å–®è©³æƒ…</h1>
        </div>
      </div>

      <span [class]="getStatusClass(orderData!.status)">
        {{ getStatusText(orderData!.status) }}
      </span>
    </div>
  </div>

  <div class="main-content">
    <div class="content-grid">

      <div class="left-column">

        <div class="card">
          <!-- <div class="card-header">
            <h3 class="card-title">
              <span>è¨‚å–®è³‡è¨Š</span>
            </h3>
          </div> -->
          <div class="card-content">
            <div class="info-grid">
              <div class="info-item">
                <label class="info-label">è¨‚å–®ç·¨è™Ÿ</label>
                <p class="info-value order-id">{{ originalOrderNumber }}</p>
              </div>

              <div class="info-item">
                <label class="info-label">ä¸‹å–®ç”¨æˆ¶</label>
                <p class="info-value user-name">
                  <span>{{ orderData.customerName }}</span>
                </p>
              </div>

              <div class="info-item">
                <label class="info-label">å¯¦ä»˜ç¸½é‡‘é¡</label>
                <p class="info-value total-amount">NT$ {{ orderData.totalAmount }}</p>
              </div>

              <div class="info-item">
                <label class="info-label">ä»˜æ¬¾æ–¹å¼</label>
                <p class="info-value payment-method">
                  <span>{{ getPaymentMethodText(orderData.paymentMethod) }}</span>
                </p>
              </div>
              <div class="info-item">
                <label class="info-label">å–é¤ç¢¼</label>
                <p class="pickup-code">{{ orderData!.pickupCode }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">é¤é»è©³æƒ…</h3>
          </div>
          <div class="card-content">
            <div class="table-container">
              <table class="items-table">
                <thead>
                  <tr>
                    <th>é¤é»ç·¨è™Ÿ</th>
                    <th>é¤é»åç¨±</th>
                    <th class="text-center">æ•¸é‡</th>
                    <th class="text-right">å–®åƒ¹</th>
                    <th class="text-right">å°è¨ˆ</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of orderData.orderFoodItemList; track trackByItem($index, item)) {

                  <tr>
                    <td class="item-id">{{ item.foodId }}</td>
                    <td class="item-name">
                      <p class="name">{{ item.foodName }}</p>
                    </td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-right food-price">NT$ {{ item.foodPrice }}</td>
                    <td class="text-right subtotal">NT$ {{ calculateSubtotal(item.foodPrice, item.quantity) }}</td>
                  </tr>
                  }
                </tbody>
              </table>
            </div>

            <div class="separator"></div>

            <div class="total-section">
              <div class="total-row">
                <span class="total-label">ç¸½è¨ˆï¼š</span>
                <span class="total-value">NT$ {{ orderData!.totalAmount }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="right-column">

        @if (orderData.customerNote) {
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <span>ç”¨æˆ¶å‚™è¨»</span>
            </h3>
          </div>
          <div class="card-content">
            <p class="customer-note">{{ orderData.customerNote }}</p>
          </div>
        </div>
        }

        @if (orderData.cancellationReason || shouldShowBackendRejectReason()) {
        <div class="card">
          <div class="card-header">
            <h3 class="card-title cancel-title">
              <label class="info-label2">ç”¨æˆ¶å–æ¶ˆåŸå› ï¼š</label>
            </h3>
          </div>
          <div class="card-content">
            @if (orderData.cancellationReason) {
            <p class="cancel-reason">{{ orderData.cancellationReason }}</p>
            }

            @if(shouldShowMerchantRejectInput()){
            <div class="form-group">
              <textarea id="rejectReason" class="reject-reason-input" [(ngModel)]="merchantRejectReason"
                [disabled]="hasSubmittedRejection" placeholder="æ¬²æ‹’çµ•å–æ¶ˆè¨‚å–®ï¼Œè«‹è¼¸å…¥åŸå› ï¼Œä¸€æ—¦æäº¤ç„¡æ³•åšä¿®æ”¹ã€‚" rows="3"></textarea>
            </div>
            }

            @if (shouldShowBackendRejectReason() && !shouldShowMerchantRejectInput()) {
            <!-- <div class="form-group"> -->
            <h3 class="card-title cancel-title">
              <label class="info-label3">å•†å®¶æ‹’çµ•åŸå› ï¼š</label>
            </h3>
            <p class="reject-reason">{{ orderData.rejectReason }}</p>
            <!-- </div> -->
            }

            @if (hasSubmittedRejection && !isHistoryOrder) {
            <p class="rejection-submitted-message">å·²æäº¤æ‹’çµ•è¨Šæ¯</p>
            }
            @if (hasApprovedCancellation && !isHistoryOrder) {
            <p class="approval-submitted-message">å·²åŒæ„å–æ¶ˆ</p>
            }


            @if (!isHistoryOrder && orderData.status === 'cancelled_by_user'){
            <div class="action-buttons">
              <button class="btn-cancelled" [disabled]="shouldDisableCancelApproval()" (click)="markOrderCanceled()">
                åŒæ„å–æ¶ˆ
              </button>

              <button class="btn-reject" [disabled]="!isRejectReasonValid() || hasSubmittedRejection"
                (click)="rejectOrderCancellation(merchantRejectReason)">
                æ‹’çµ•å–æ¶ˆ
              </button>
            </div>
            }
          </div>
        </div>
        }


        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <span>æ™‚é–“è»¸</span>
            </h3>
          </div>
          <div class="card-content">
            <div class="timeline">
              <div class="timeline-item">
                <div class="timeline-dot blue"></div>
                <div class="timeline-content">
                  <p class="timeline-title">è¨‚å–®å»ºç«‹</p>
                  <p class="timeline-time">{{ orderData!.orderTime }}</p>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-dot yellow"></div>
                <div class="timeline-content">
                  <p class="timeline-title">æœ€å¾Œæ›´æ–°</p>
                  <p class="timeline-time">{{ orderData!.updatedAt }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        @if(!isHistoryOrder){
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <span>è¨‚å–®è¨­å®š</span>
            </h3>
          </div>
          <div class="card-content">
            <button class="btn-complete" [disabled]="
                orderData.status === 'completed' ||
                orderData.status === 'cancelled_by_user' ||
                orderData.status === 'cancelled_by_merchant' ||
                orderData.status === 'not_token'" (click)="markOrderComplete()">è¨‚å–®å®Œæˆ</button>

            <button class="btn-not-taken"
              [disabled]="orderData.status === 'completed' ||
              orderData.status === 'cancelled_by_user' ||
              orderData.status === 'cancelled_by_merchant' ||
              orderData.status === 'not_token'" (click)="markAsNotTaken()">
              æœªå–é¤
            </button>
          </div>

        </div>
        }
      </div>
    </div>
  </div>
</div>
}
