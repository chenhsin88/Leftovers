<!-- é é¢æ¨™é¡Œå€åŸŸ (ä¿æŒä¸è®Š) -->
<div class="header-section">
  <div class="header-content">
    <h1 class="header-title">æ­·å²è¨‚å–®</h1>
  </div>
</div>

<div class="main-card">
  <div class="main-content">
    <!-- ===== 1. æ¦‚è¦½è¦–åœ– ===== -->
    @if (view() === 'overview') {
    <!-- å…¨åŸŸæœå°‹å€åŸŸ -->
    <div class="search-filter-card">
      <div class="search-filter-content">
        <div class="search-filter-row">
          <!-- æœå°‹æ¡† -->
          <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" placeholder="æœå°‹å¹´ä»½ã€æœˆä»½ã€è¨‚å–®ç·¨è™Ÿã€ä¸‹å–®ç”¨æˆ¶" [ngModel]="searchTerm()"
              (ngModelChange)="onSearchChange($event)" />
          </div>
        </div>
      </div>
    </div>

    <!-- å…§å®¹å€åŸŸ -->
    <div class="content-wrapper">
      <!-- A. æœå°‹çµæœè¦–åœ– -->
      @if (searchTerm()) {
      <div class="search-results-section">
        <h2 class="section-title">æœå°‹çµæœ</h2>
        <div class="orders-container">
          @for (order of globalSearchResults(); track order.orderNumber) {
          <!-- è¤‡ç”¨è¨‚å–®å¡ç‰‡ -->
          <div class="order-card" [routerLink]="['/merchants', storeId(), 'orderDetail', order.orderNumber]"
            [queryParams]="{ returnUrl: '/merchants/' + storeId() + '/orderHistory' }">
            <div class="order-content">
              <div class="order-header"><span class="order-number">{{ order.orderNumber }}</span></div>
              <div class="order-info">
                <div class="info-item">
                  <p class="label">ä¸‹å–®ç”¨æˆ¶</p>
                  <p>{{ order.userName }}</p>
                </div>
                <div class="info-item">
                  <p class="label">é‡‘é¡</p>
                  <p class="value">NT$ {{ order.totalAmount | number }}</p>
                </div>
                <div class="info-item">
                  <p class="label">ä¸‹å–®æ™‚é–“</p>
                  <p class="value">{{ order.orderDate | date:'yyyy/MM/dd HH:mm' }}</p>
                </div>
              </div>
            </div>
            <div class="arrow-icon">â€º</div>
          </div>
          } @empty {
          <div class="empty-state">
            <div class="empty-icon">ğŸ§</div>
            <h3 class="empty-title">æ‰¾ä¸åˆ°ç¬¦åˆçš„è¨‚å–®</h3>
            <p class="empty-message">è«‹å˜—è©¦æ›´æ›é—œéµå­—</p>
          </div>
          }
        </div>
      </div>
      }

      <!-- B. é è¨­å¯æ”¶åˆåˆ—è¡¨ -->
      @if (!searchTerm()) {
      <div class="overview-section">
        <!-- ä»Šå¹´è¨‚å–® -->
        <div class="collapsible-group">
          <button class="collapsible-header" (click)="toggleThisYear()"><span>ä»Šå¹´è¨‚å–® ({{ thisYear }})</span><span
              class="chevron" [class.rotated]="isThisYearExpanded()">â¬‡ï¸</span></button>
          @if (isThisYearExpanded()) {
          <div class="collapsible-content">
            <div class="simple-grid month-grid">
              @for (month of currentYearMonths(); track month) {
              <!-- é€™å€‹æŒ‰éˆ•ç¾åœ¨æœƒå°èˆªåˆ°è¨‚å–®åˆ—è¡¨ -->
              <button class="grid-button month-button" (click)="navigateToOrders(thisYear, month)">
                {{ getMonthName(month) }}
              </button>
              } @empty { <p class="no-data-message">ä»Šå¹´å°šç„¡è¨‚å–®</p> }
            </div>
          </div>
          }
        </div>
        <!-- æ­·å¹´è¨‚å–® -->
        <div class="collapsible-group">
          <button class="collapsible-header" (click)="togglePastYears()"><span>æ­·å¹´è¨‚å–®</span><span class="chevron"
              [class.rotated]="isPastYearsExpanded()">â¬‡ï¸</span></button>
          @if (isPastYearsExpanded()) {
          <div class="collapsible-content">
            <div class="simple-grid year-grid">
              @for (year of pastYears(); track year) {
              <!-- (ä¿®æ­£) é€™å€‹æŒ‰éˆ•ç¾åœ¨æœƒå°èˆªåˆ°è©²å¹´ä»½çš„æœˆä»½åˆ—è¡¨ -->
              <button class="grid-button year-button" (click)="navigateToMonthsForYear(year)">{{ year }} å¹´</button>
              } @empty { <p class="no-data-message">æ²’æœ‰æ›´æ—©çš„æ­·å²è¨‚å–®</p> }
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>
    }
    <!-- ===== 2. æœˆä»½åˆ—è¡¨ (ç”¨æ–¼æ­·å¹´) ===== -->
    @if (view() === 'months') {
    <div class="drilldown-view-section">
      <button class="back-button" (click)="goBack()">â† è¿”å›åˆ—è¡¨</button>
      <h2 class="section-title">{{ currentYear() }}å¹´ è¨‚å–®æœˆä»½</h2>
      <div class="simple-grid month-grid">
        @for (month of monthsForSelectedYear(); track month) {
        <button class="grid-button month-button" (click)="navigateToOrders(currentYear()!, month)">
          {{ getMonthName(month) }}
        </button>
        } @empty {
        <p class="no-data-message">è©²å¹´åº¦æ²’æœ‰è¨‚å–®</p>
        }
      </div>
    </div>
    }
    <!-- ===== 3. è¨‚å–®åˆ—è¡¨ (å…±ç”¨) ===== -->
    @if (view() === 'orders') {
    <div class="drilldown-view-section">
      <button class="back-button" (click)="goBack()">
        â† è¿”å›åˆ—è¡¨
      </button>
      <h2 class="section-title">{{ currentYear() }}å¹´ {{ getMonthName(currentMonth()!) }} è¨‚å–®åˆ—è¡¨</h2>
      <div class="orders-container">
        @for (order of ordersForSelectedMonth(); track order.orderNumber) {
        <!-- å†æ¬¡è¤‡ç”¨è¨‚å–®å¡ç‰‡ -->
        <div class="order-card" [routerLink]="['/merchants', storeId(), 'orderDetail', order.orderNumber]"
          [queryParams]="{ returnUrl: '/merchants/' + storeId() + '/orderHistory' }">
          <div class="order-content">
            <div class="order-header"><span class="order-number">{{ order.orderNumber }}</span></div>
            <div class="order-info">
              <div class="info-item">
                <p class="label">ä¸‹å–®ç”¨æˆ¶</p>
                <p class="value">{{ order.userName }}</p>
              </div>
              <div class="info-item">
                <p class="label">é‡‘é¡</p>
                <p class="value">NT$ {{ order.totalAmount | number }}</p>
              </div>
              <div class="info-item">
                <p class="label">ä¸‹å–®æ™‚é–“</p>
                <p class="value">{{ order.orderDate | date:'yyyy/MM/dd HH:mm' }}</p>
              </div>
            </div>
          </div>
          <div class="arrow-icon">â€º</div>
        </div>
        } @empty {
        <div class="empty-state">
          <div class="empty-icon">ğŸ“‚</div>
          <h3 class="empty-title">é€™å€‹æœˆæ²’æœ‰è¨‚å–®</h3>
        </div>
        }
      </div>
    </div>
    }

  </div>
</div>
