<div class="container">
  <div class="flex flex-col gap-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div>
        <h1 class="text-3xl font-bold">我的訂單</h1>
      </div>
    </div>

    <div class="flex gap-4">
      <button class="button"
        [ngClass]="{'button-primary': viewMode === 'today', 'button-outline': viewMode !== 'today'}"
        (click)="setViewMode('today')">
        今日訂單資訊
      </button>
      <button class="button"
        [ngClass]="{'button-primary': viewMode === 'history', 'button-outline': viewMode !== 'history'}"
        (click)="setViewMode('history')">
        歷史訂單資訊
      </button>
    </div>

    @if (viewMode === 'today') {
    <div class="card-group-flex-4 gap-4">
      <div class="card card-blue-bg">
        <div class="card-header flex flex-row items-center justify-between space-y-0 pb-2">
          <div class="card-title text-sm font-medium">今日待取貨</div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-6 w-6 text-blue-700">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="m9 12 2 2 4-4"></path>
          </svg>
        </div>
        <div class="card-content">
          <div class="text-3xl font-bold">{{ getTodayReadyForPickupAndOrderedCount() }} 筆</div>
          <p class="text-sm text-muted-foreground mt-1">包含已下單與待取貨訂單</p>
        </div>
      </div>
      <div class="card card-green-bg">
        <div class="card-header flex flex-row items-center justify-between space-y-0 pb-2">
          <div class="card-title text-sm font-medium">今日已取貨</div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-6 w-6 text-green-700">
            <path d="M22 11.08V12a10 0 1 1 -5.93 -8.5"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="card-content">
          <div class="text-3xl font-bold">{{ getTodayCompletedCount() }} 筆</div>
          <p class="text-sm text-muted-foreground mt-1">今日已成功取貨的訂單</p>
        </div>
      </div>
      <div class="card card-yellow-bg">
        <div class="card-header flex flex-row items-center justify-between space-y-0 pb-2">
          <div class="card-title text-sm font-medium">今日申請取消</div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-6 w-6 text-orange-600">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </div>
        <div class="card-content">
          <div class="text-3xl font-bold">{{ getTodayCancellationRequestedCount() }} 筆</div>
          <p class="text-sm text-muted-foreground mt-1">等待商家審核</p>
        </div>
      </div>
      <div class="card card-red-bg">
        <div class="card-header flex flex-row items-center justify-between space-y-0 pb-2">
          <div class="card-title text-sm font-medium">今日已取消</div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-6 w-6 text-red-600">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
        <div class="card-content">
          <div class="text-3xl font-bold">{{ getTodayCancelledCount() }} 筆</div>
          <p class="text-sm text-muted-foreground mt-1">今日已關閉的訂單</p>
        </div>
      </div>
    </div>
    } @else {
    <div class="card-group-flex-2 gap-4">
      <div class="card card-green-bg">
        <div class="card-header flex flex-row items-center justify-between space-y-0 pb-2">
          <div class="card-title text-sm font-medium">歷史已完成訂單</div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-6 w-6 text-green-600">
            <path d="M22 11.08V12a10 0 1 1-5.93-8.5"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="card-content">
          <div class="text-3xl font-bold">{{ getHistoryCompletedOrdersCount() }} 筆</div>
          <p class="text-sm text-muted-foreground mt-1">您歷史上已成功取貨的訂單</p>
        </div>
      </div>
      <div class="card card-red-bg">
        <div class="card-header flex flex-row items-center justify-between space-y-0 pb-2">
          <div class="card-title text-sm font-medium">歷史已取消訂單</div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-6 w-6 text-red-600">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="6" y2="18"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
        <div class="card-content">
          <div class="text-3xl font-bold">{{ getHistoryCancelledOrdersCount() }} 筆</div>
          <p class="text-sm text-muted-foreground mt-1">歷史上已關閉的訂單</p>
        </div>
      </div>
    </div>
    }

    <div class="card bg-base-200 shadow-sm p-4">
      <div class="card bg-base-200 shadow-sm p-4">
        <h2 class="text-lg font-bold text-base-content mb-4">篩選訂單</h2>
      </div>
      <div class="card-content">
        <div class="flex items-center gap-4">
          <div class="relative flex-grow">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="absolute left-2 top-2.5 h-5 w-5 text-muted-foreground">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
            <input type="text" placeholder="搜尋訂單編號或商品名稱..." [(ngModel)]="searchTerm"
              (ngModelChange)="updateDisplayedOrders()" class="input pl-8" />
          </div>

          <div class="relative w-48 flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="absolute left-2 top-2.5 h-5 w-5 mr-2 text-muted-foreground">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            <select [(ngModel)]="statusFilter" (ngModelChange)="updateDisplayedOrders()" class="select pl-8">
              @if (viewMode === 'today') {
              @for (option of todayStatusOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
              }
              } @else {
              @for (option of historyStatusOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
              }
              }
            </select>
          </div>
        </div>

        @if (viewMode === 'history') {
        <div class="flex flex-col sm:flex-row items-center gap-4 mt-4">
          <div class="relative flex-grow">
            <label for="startDate" class="text-sm text-muted-foreground block mb-1">開始日期</label>
            <input type="date" id="startDate" [(ngModel)]="startDateFilter" (ngModelChange)="updateDisplayedOrders()"
              [max]="endDateFilter" class="input w-full">
          </div>
          <div class="relative flex-grow">
            <label for="endDate" class="text-sm text-muted-foreground block mb-1">結束日期</label>
            <input type="date" id="endDate" [(ngModel)]="endDateFilter" (ngModelChange)="updateDisplayedOrders()"
              [min]="startDateFilter" class="input w-full">
          </div>
        </div>
        }
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="flex justify-between items-center w-full table-header-flex">
          <div class="card-title">
            @if (viewMode === 'today') {
            今日訂單列表
            } @else {
            歷史訂單列表
            }
          </div>
          <div class="flex items-baseline gap-2">
            <div class="card-description">找到 {{ filteredOrders.length }} 筆訂單</div>
            @if (viewMode === 'today') {
            <span class="text-lg font-semibold text-primary-dark total-spending-align">
              總花費: NT${{ getTodayTotalSpending()}}
            </span>
            }
          </div>
        </div>
      </div>
      <div class="card-content">
        <div class="table-container">
         <table>
            <thead>
              <tr>
                <th>訂單編號</th>
                <th>日期</th>
                <th>狀態</th>
                <th>商品數量</th>
                <th>總金額</th>
                <th class="action-col-align">操作</th>
              </tr>
            </thead>
            <tbody>
              @for (order of filteredOrders; track order.id) {
              <tr>
                <td class="font-medium">{{ order.id }}</td>
                <td>{{ order.date | date: 'yyyy-MM-dd' }}</td>
                <td><span class="badge" [ngClass]="getStatusBadgeClass(order.status)">{{
                    getStatusBadgeText(order.status) }}</span></td>
                <td>{{ order.items }} 件</td>
                <td>NT${{ order.total}}</td>

                <td class="action-col-align">
                  <div class="flex justify-center gap-2">

                    <button class="button button-outline button-icon" (click)="openOrderDetails(order)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="h-4 w-4">
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>


                  </div>
                </td>
                </tr>
              } @empty {
              <tr>
                <td colspan="6" class="text-center text-muted-foreground p-4">
                  目前沒有符合條件的訂單。
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    @if (selectedOrder) {
    <div class="modal-overlay" (click)="closeOrderDetails()">
      <div class="card modal-content" (click)="$event.stopPropagation()">
        <div class="card-header">
          <div class="flex justify-between items-center w-full">
            <div>
              <div class="card-title">訂單詳情 - {{ selectedOrder.id }}</div>
              <div class="card-description">訂單日期：{{ selectedOrder.date | date: 'yyyy-MM-dd' }}</div>
            </div>
            <button class="button button-outline" (click)="closeOrderDetails()">關閉</button>
          </div>
        </div>
        <div class="card-content">
          <div class="space-y-6">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm text-muted-foreground">訂單狀態</p>
                <span class="badge" [ngClass]="getStatusBadgeClass(selectedOrder.status)">
                  {{ getStatusBadgeText(selectedOrder.status) }}
                </span>
              </div>
            </div>

            @if (selectedOrder.status === 'ordered') {
            <div class="pickup-info-section ordered-info"> @if (!isCancelling) {
              <h4 class="font-semibold mb-3 text-lg">訂單已成立，請前往門市付款取貨！</h4>
              <p class="text-sm text-muted-foreground mb-3">請攜帶足額現金或使用其他支付方式前往門市完成付款。</p>
              @if (selectedOrder.pickupInfo) {
              <div class="info-item">
                <span class="text-muted-foreground font-medium">取貨門市：</span>
                <span class="font-bold">{{ selectedOrder.pickupInfo.storeName }}</span>
              </div>
              <div class="info-item">
                <span class="text-muted-foreground font-medium">門市地址：</span>
                <span>{{ selectedOrder.pickupInfo.address }}</span>
              </div>
              <div class="info-item" style="align-items: flex-start;">
                <span class="text-muted-foreground font-medium" style="white-space: nowrap;">營業時間：</span>
                <div>
                  @for (line of selectedOrder.pickupInfo.openingHours; track line) {
                  <p style="margin: 0; line-height: 1.6;">{{ line }}</p>
                  }
                </div>
              </div>
              <div class="info-item">
                <span class="text-muted-foreground font-medium">門市電話：</span>
                <a href="tel:{{ selectedOrder.pickupInfo.contactPhone }}">{{ selectedOrder.pickupInfo.contactPhone
                  }}</a>
              </div>
              <div class="info-item highlight-code">
                <span class="text-muted-foreground font-medium">您的取貨碼：</span>
                <span class="text-3xl font-bold text-blue-800">{{ selectedOrder.pickupInfo.pickupCode }}</span>
              </div>
              }
              <button class="button button-outline mt-4" (click)="requestCancelOrder()">申請取消訂單</button>
              } @else {
              <div class="mt-4 cancellation-input-content">
                <h4 class="font-semibold mb-3 text-lg">請輸入取消原因</h4>
                <textarea class="input mb-3" rows="3" [(ngModel)]="cancellationReasonInput"
                  placeholder="請在此輸入您的取消原因"></textarea>
                <div class="flex gap-2 justify-center">
                  <button class="button button-danger" (click)="confirmCancelOrder()">確認取消</button>
                  <button class="button button-outline" (click)="cancelCancelRequest()">取消</button>
                </div>
              </div>
              }
            </div>
            }
            @else if (selectedOrder.status === 'ready_for_pickup' && selectedOrder.pickupInfo) {
            <div class="pickup-info-section ready-for-pickup-info">
              <h4 class="font-semibold mb-3 text-lg">您的商品已備妥，請前往取貨！</h4>
              <div class="info-item">
                <span class="text-muted-foreground font-medium">取貨門市：</span>
                <span class="font-bold">{{ selectedOrder.pickupInfo.storeName }}</span>
              </div>
              <div class="info-item">
                <span class="text-muted-foreground font-medium">門市地址：</span>
                <span>{{ selectedOrder.pickupInfo.address }}</span>
              </div>
              <div class="info-item" style="align-items: flex-start;">
                <span class="text-muted-foreground font-medium" style="white-space: nowrap;">營業時間：</span>
                <div>
                  @for (line of selectedOrder.pickupInfo.openingHours; track line) {
                  <p style="margin: 0; line-height: 1.6;">{{ line }}</p>
                  }
                </div>
              </div>
              <div class="info-item">
                <span class="text-muted-foreground font-medium">門市電話：</span>
                <a href="tel:{{ selectedOrder.pickupInfo.contactPhone }}">{{ selectedOrder.pickupInfo.contactPhone
                  }}</a>
              </div>
              <div class="info-item highlight-code">
                <span class="text-muted-foreground font-medium">您的取貨碼：</span>
                <span class="text-3xl font-bold text-blue-800">{{ selectedOrder.pickupInfo.pickupCode }}</span>
              </div>
              <p class="text-sm text-muted-foreground mt-2 text-center">請攜帶此取貨碼至門市，以便快速領取商品。</p>
            </div>
            }
            @else if (selectedOrder.status === 'cancellation_requested') {
            <div class="pickup-info-section cancellation-requested-info">
              <h4 class="font-semibold mb-2 text-lg">取消申請已送出！</h4>
              <p class="text-muted-foreground">您的取消訂單申請已提交，正在等待商家審核。</p>
              <p class="text-muted-foreground">請留意訂單狀態更新或客服通知。</p>
              @if (selectedOrder.cancellationReason) {
              <div class="info-item cancellation-reason mt-4">
                <span class="text-muted-foreground font-medium">取消原因：</span>
                <span>{{ selectedOrder.cancellationReason }}</span>
              </div>
              }
            </div>
            }
            @else if (selectedOrder.status === 'cancelled') {
            <div class="pickup-info-section cancelled-info">
              <h4 class="font-semibold mb-2 text-lg text-red-600">此訂單已被取消。</h4>
              @if (selectedOrder.cancellationReason) {
              <div class="info-item cancellation-reason mt-2">
                <span class="text-muted-foreground font-medium">取消原因：</span>
                <span>{{ selectedOrder.cancellationReason }}</span>
              </div>
              }
              @if (selectedOrder.pickupInfo) { <div class="info-item mt-2">
                <span class="text-muted-foreground font-medium">購買商店：</span>
                <span class="font-bold">{{ selectedOrder.pickupInfo.storeName }}</span>
              </div>
              }
            </div>
            }
            @else if (selectedOrder.status === 'completed') {

  <div class="pickup-info-section completed-info">
    <h4 class="font-semibold mb-2 text-lg text-green-600">此訂單已完成取貨。</h4>
    <p class="text-muted-foreground">感謝您的使用！</p>
    @if (selectedOrder.pickupInfo) {
      <div class="info-item mt-2">
        <span class="text-muted-foreground font-medium">購買商店：</span>
        <span class="font-bold">{{ selectedOrder.pickupInfo.storeName }}</span>
      </div>
    }
  </div>

  <div class="divider my-4"></div>

  <div>
    @if (isCheckingReview) {
      <div class="flex justify-center items-center p-8">
        <span class="loading loading-spinner loading-lg"></span>
      </div>

    } @else {@if (existingReview) {
      <h4 class="font-semibold mb-3 text-lg">您的評價</h4>
<div class="flex justify-center">
  <div class="rating rating-lg gap-1 mb-4">
    @for (star of [1, 2, 3, 4, 5]; track star) {
      <input type="radio" name="rating-display" class="mask mask-star-2 bg-orange-400"
             [checked]="star === existingReview.rating" disabled />
    }
  </div>
</div>

      @if (existingReview.comment) {
        <p class="p-4 bg-base-200 rounded-lg whitespace-pre-wrap min-h-[80px]">{{ existingReview.comment }}</p>
      } @else {
        <p class="p-4 bg-base-200 rounded-lg text-base-content/60 italic min-h-[80px]">(您沒有留下文字評論)</p>
      }

    } @else if (isReviewable(selectedOrder)) {
      <h4 class="font-semibold mb-3 text-lg">為這次的訂單評分</h4>
<div class="flex justify-center">
  <div class="rating rating-lg gap-1 mb-4">
  @for (star of [1, 2, 3, 4, 5]; track star) {
    <input type="radio" name="rating-interactive" class="mask mask-star-2 bg-orange-400 cursor-pointer h-30 w-30"
           (click)="setRating(star)" [checked]="star === reviewRating" />
  }
</div>
</div>

      <textarea class="textarea textarea-bordered w-full mb-4" rows="4" placeholder="分享您的用餐體驗… (選填)" [(ngModel)]="reviewComment"></textarea>

      <button class="btn btn-primary w-full" (click)="submitReview()">提交評論</button>
    }
  }
  </div>

}

            <div>
              <h4 class="font-semibold mb-3">商品清單</h4>
              <div class="space-y-2">
                @for (product of selectedOrder.products; track product.name + product.quantity) {
                <div class="flex justify-between items-center product-item">
                  <div>
                    <p class="font-medium">{{ product.name }}</p>
                    <p class="text-sm text-muted-foreground">數量：{{ product.quantity }}</p>
                  </div>
                  <p class="font-medium">NT${{ product.price}}</p>
                </div>
                } @empty {
                <p class="text-muted-foreground">此訂單沒有商品。</p>
                }
              </div>
            </div>

            <div class="border-t pt-4">
              <div class="flex justify-between items-center">
                <p class="text-lg font-semibold">總計</p>
                <p class="text-lg font-bold">
                  NT${{ selectedOrder.total}}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    }
  </div>
</div>
